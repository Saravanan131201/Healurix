{% extends "basic.html" %}
{% load static %}
{% load last_seen %}


{% block head %}

  <link rel="stylesheet" href="{% static 'consultation/consultation.css' %}">

  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">


  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">

<!-- Bootstrap 5 CSS -->
<!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"> -->




{% endblock %}




{% block body %}



<br>
<center>
  <h2>Healurix Chat Consultation</h2>
  
  {% if messages %}
  <div class="container mt-2">
    {% for message in messages %}
      <div class="alert alert-success alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
    {% endfor %}
  </div>
{% endif %}

</center>
<br>



<div class="row">


  <div class="col">

    {% if user.patient.is_patient %}
    <div class="container ml-5 mr-5">
      <button type="button" class="btn btn-outline-secondary" data-toggle="collapse" data-target="#demo">Give Rating and
        Reviews to Dr. {{consultation.doctor.name}}</button>
      <div id="demo" class="collapse">

        <form action="{% url 'rate_review' consultation.id %}" method="POST">
          {% csrf_token %}
          <div class="form-group mt-2">
            <i class="bi bi-star-fill text-warning"></i>
            <label for="sel1">Rate (Out of 5):</label>
            <div class="row">
              <div class="col-sm-3">
              <input type="number" id="rating" name="rating" class="form-control" step="0.1" min="1" max="5" required
                placeholder="e.g., 4.5">
              </div>
            </div>



            <br>
            <label for="comment">Reviews:</label>
            <textarea class="form-control" rows="5" id="comment" name="review"></textarea>
          </div>
          <button type="submit" class="btn btn-primary">Submit</button>
        </form>

      </div>

    </div>
    {% endif %}


    <!-- Display Predicted disease details -->

    <div class="card mt-5 ml-5 mr-5 mb-5">

      <div class="card-body">
        <h4 class="card-title">Predicted disease : 
        {% with consultation.diseaseinfo.diseasename as diseasename %}
          {% if diseasename == 'Dimorphic hemmorhoids(piles)' %}
              Hemmorhoids(piles)
          {% elif diseasename == 'Peptic ulcer diseae' %}
               Peptic Ulcer Disease
          {% elif diseasename == 'Drug Reaction' %}
              Adverse Drug Reaction
          {% elif diseasename == 'Chronic cholestasis' %}
              Chronic Cholecystitis
          {% elif diseasename == 'Arthritis' %}
              Rheumatoid Arthritis
          {% else %}
             {% if diseasename != 'GERD' and diseasename != 'AIDS' %} 
                {{ diseasename|title }} 
              {% else %} 
                {{ diseasename }} 
              {% endif %}
          {% endif %} 
        {% endwith %}
        </h4>
        <p class="card-text">List of symptoms -

        <ul class="list-group">
          {% for i in consultation.diseaseinfo.symptomsname %}
          <li class="list-group-item" style="background-color:aliceblue">{{i}}</li>
          {% endfor %}
        </ul>


        </p>
        <p class="card-text">Confident score - {{consultation.diseaseinfo.confidence}} %</p>
        <p class="card-text">Patient age - {{consultation.patient.age}}</p>

        <p class="card-text">Consultation date - {{consultation.consultation_date}}</p>
        <p class="card-text" style="color: green;">Consultation status - {{consultation.status | title}}</p>
      </div>
    </div>


    
    <!-- Close consultation -->

  {% if user.doctor.is_doctor %}

    <!-- Close consultation and Next consultation date -->
    
    <div class="container mt-4 ml-5 mr-5">
      <button type="button" class="btn btn-outline-danger mb-4" data-toggle="collapse" data-target="#demo2">
        <i class="fas fa-window-close"></i>
        Close Consultation</button>

      <div id="demo2" class="collapse">

        <form action="{% url 'close_consultation' consultation.id %}" method="POST">
          {% csrf_token %}

            <div class="form-group mt-2">
              <label>Next Consultation Date (optional):</label>
              <input type="date" name="next_consultation_date" class="form-control">
            </div>
        
              Are you sure to close consultation ?
              <br>

              <button type="submit" class="btn btn-outline-success mr-2 mt-2" style="display:inline-block">Yes</button>

              <button type="button" class="btn btn-outline-danger mt-2" id="close-no-btn">
                NO
              </button>

              

        </form>
      </div>

    </div>


    <!-- Add Prescription -->

    <div class="container mt-4 ml-5 mr-5">
      <div class="position-relative d-inline-block" id="prescription-wrapper">
        <!-- Toggle Button -->
        <button type="button" class="btn btn-outline-success mb-4"id="toggle-prescription"> 
          <i class="fas fa-prescription"></i> &nbsp; Add Prescription
        </button> 

        <!-- Collapsible Panel -->
        <div class="collapse position-absolute start-100 top-0 ms-2 z-3" id="add-presc">
          <div class="card card-body p-2 shadow border-success" style="font-size: 0.875rem; width: 250px;">
            <span>Prescribe medicines, tests, and instructions for the patient</span> <br>
            <a href="{% url 'add_prescription' consultation.id %}" class="btn btn-sm btn-success mt-2">Add Now</a>
          </div>
        </div>
      </div>
    </div>




   

    

{% endif %}


    <br><br>


    <div class="card mt-5 ml-5 mr-5 mb-5">
      <div class="text-center ">

        {% if consultation.patient.gender == 'male' %}
          <img class="card-img" src="{% static 'homepage/male_patient.png' %}" alt="Card image" >
        {% else %}
          <img class="card-img" src="{% static 'homepage/female_patient.png' %}" alt="Card image" >
        {% endif %} 

      </div>
      <div class="card-body">
        <h4 class="card-title">Patient name : {{consultation.patient.name}}</h4>
        <p class="card-text">Patient ID - {{consultation.patient.user_id}}</p>
        <p class="card-text">Patient email - {{consultation.patient.user.email}}</p>
        <p class="card-text">patient phone no. - {{consultation.patient.mobile_no}}</p>
        <a href="{% url 'pviewprofile' consultation.patient.user.username %}" class="btn btn-primary">View Profile</a>
      </div>
    </div>


    <div class="card mt-5 ml-5 mr-5 mb-5">
      <div class="text-center " >

       {% if consultation.doctor.gender == 'male' %}
        <img class="card-img" src="{% static 'homepage/male_doctor.png' %}" alt="Card image" >
      {% else %}
        <img class="card-img" src="{% static 'homepage/female_doctor.png' %}" alt="Card image" >
      {% endif%}

      </div>
      <div class="card-body" style="display: inline-block;">
        <h4 class="card-title">Doctor name : {{consultation.doctor.name}}</h4>
        <p class="card-text">Doctor ID - {{consultation.doctor.user_id}}</p>
        <p class="card-text">Doctor email - {{consultation.doctor.user.email}}</p>
        <p class="card-text">Doctor phone no. - {{consultation.doctor.mobile_no}}</p>
        {% if consultation.doctor.rating %}
        <p class="card-text">Doctor rating - {{consultation.doctor.rating}}/5</p>
        {% endif %}
        <a href="{% url 'dviewprofile' consultation.doctor.user.username %}" class="btn btn-primary">View Profile</a>
      </div>
    </div>


<br><br><br><br><br><br>

  </div> <!-- col 1 ends here................................................ -->





<div class="col-12 col-md">
  <div class="container-fluid border border-success rounded-lg" id="chat_window" style="background-color: #1423301a !important;">
    <div id="chat-body" class="panel panel-default p-3">
      <div class="panel-heading d-flex align-items-center mb-3">
        {% if user.patient.is_patient %}
          {% if consultation.doctor.gender == 'male' %}
            <img src="{% static 'homepage/male_doctor_clipart.png' %}" class="rounded-circle me-3" width="50" height="50">
          {% else %}
            <img src="{% static 'homepage/female_doctor_clipart.png' %}" class="rounded-circle me-3" width="50" height="50">
          {% endif %}
          <div>
            <div class="fw-bold text-white">Dr. {{ consultation.doctor.name }}</div>
            <small class="text-white">
              {% if consultation.doctor.last_seen|is_active_now %}
                Active now
              {% elif consultation.doctor.last_seen %}
                Last seen {{ consultation.doctor.last_seen|format_last_seen }}
              {% elif consultation.doctor.user.last_login %}
                Last seen {{ consultation.doctor.user.last_login|format_last_seen }}
              {% else %}
                Available Soon
              {% endif %}
            </small>
          </div>
        {% else %}
          {% if consultation.patient.gender == 'male' %}
            <img src="{% static 'homepage/male_patient_clipart.png' %}" class="rounded-circle me-3" width="50" height="50">
          {% else %}
            <img src="{% static 'homepage/female_patient_clipart.png' %}" class="rounded-circle me-3" width="50" height="50">
          {% endif %}
          <div>
            <div class="fw-bold text-white">{{ consultation.patient.name }}</div>
            <small class="text-white">
              {% if consultation.patient.last_seen|is_active_now %}
                Active now
              {% else %}
                Last seen {{ consultation.patient.last_seen|format_last_seen }}
              {% endif %}
            </small>
          </div>
        {% endif %}
      </div>

      <div id="msg-list-div" class="panel-body">
        <ul id="msg-list" class="list-group">
          {% include 'consultation/chat_body.html' %}
          <script>
            var chatlist = document.getElementById('msg-list-div');
            chatlist.scrollTop = chatlist.scrollHeight;
          </script>
        </ul>
      </div>

      <br>

      <div id="chat-form" class="container-fluid"> {% csrf_token %}
        <div id="chat-bottom" class="input-group position-relative">
          <input type="text" id="chat-msg" name="chat-msg" class="form-control" placeholder="Type a message" />

          <button type="button" id="emoji-toggle" class="btn btn-outline-secondary">ðŸ˜Š</button>

          <div class="input-group-append">
            <button class="btn btn-primary" id="send" type="submit" value="Send">Send</button>
          </div>

          <div id="emoji-picker" class="border rounded p-2 bg-white shadow-sm d-none position-absolute"
              style="bottom: 50px; left: 10px; max-width: 300px; max-height: 150px; overflow-y: auto; z-index: 999; flex-wrap: wrap;">
          </div>
        </div>
      </div>
    </div>
  </div>
</div>






  <script>

    $('#send').click(function (event) {
      event.preventDefault();

      $.ajax({
        url: "{% url 'post' %}",
        type: "POST",
        data: {
          msgbox: $('#chat-msg').val(),
          csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
        },

        success: function (json) {
          console.log(json);
          $('#chat-msg').val('');
          $('#msg-list').append('<li class="text-right list-group-item">' + json.msg + '</li>');

        }
      });



    });


    function getMessages() {
      if (!scrolling) {
        $.ajax({
          url: "{% url 'chat_messages' %}",
          type: "GET",

          success: function (messages) {
            $('#msg-list').html(messages);
            var chatlist = document.getElementById('msg-list-div');
            chatlist.scrollTop = chatlist.scrollHeight;
          }
        });
      }
      scrolling = false;
    }

    var scrolling = false;

    $(function () {
      $('#msg-list-div').on('scroll', function () {
        scrolling = true;
      });
      refreshTimer = setInterval(getMessages, 2000);
    });

    $(document).ready(function () {

      getMessages();

      $('#send').attr('disabled', 'disabled');
      $('#chat-msg').keyup(function () {
        if ($(this).val() != '') {
          $('#send').removeAttr('disabled');
        }
        else {
          $('#send').attr('disabled', 'disabled');
        }
      });
    });

  </script>


<script>
  document.addEventListener('DOMContentLoaded', function () {
    const emojiToggle = document.getElementById('emoji-toggle');
    const emojiPicker = document.getElementById('emoji-picker');
    const chatInput = document.getElementById('chat-msg');


    const emojis = [

   // ðŸ™‚ Emotional Reactions
  'ðŸ˜Š','ðŸ˜','ðŸ˜„','ðŸ˜ƒ','ðŸ™‚','ðŸ™ƒ','ðŸ˜‰','ðŸ˜Œ','ðŸ˜','ðŸ¤©','ðŸ¥°','ðŸ˜˜','ðŸ˜—','ðŸ˜š','ðŸ˜™','ðŸ˜‹','ðŸ˜œ','ðŸ˜','ðŸ˜›','ðŸ« ',
  
  // ðŸ¤” Other Faces
  'ðŸ¤”','ðŸ˜','ðŸ˜‘','ðŸ˜¶','ðŸ˜','ðŸ˜’','ðŸ™„','ðŸ˜¬','ðŸ¤¥','ðŸ˜®','ðŸ˜²','ðŸ˜³','ðŸ¥±','ðŸ˜¤','ðŸ˜ ','ðŸ˜¡','ðŸ¤¬','ðŸ˜ž','ðŸ˜Ÿ','ðŸ˜¢',

  // ðŸ‘¨â€âš•ï¸ Doctors, Nurses, Med Staff
  'ðŸ‘¨â€âš•ï¸','ðŸ‘©â€âš•ï¸','ðŸ§‘â€âš•ï¸','ðŸ‘¨â€ðŸ”¬','ðŸ‘©â€ðŸ”¬','ðŸ§‘â€ðŸ”¬','ðŸ‘¨â€ðŸ«','ðŸ‘©â€ðŸ«','ðŸ‘¨â€ðŸ’¼','ðŸ‘©â€ðŸ’¼','ðŸ§‘â€ðŸ’¼','ðŸ§‘â€ðŸ«',
  
  // ðŸ¥ Hospital, Equipment, Tools
  'ðŸ¥','ðŸš‘','ðŸ©º','ðŸ’‰','ðŸ’Š','ðŸ©¹','ðŸ§¬','ðŸ§«','ðŸ§ª','ðŸ©»','ðŸ§¯','âš•ï¸','â›‘ï¸',

  // ðŸ§  Organs, Body Parts
  'ðŸ§ ','ðŸ«€','ðŸ«','ðŸ¦·','ðŸ¦´','ðŸ‘ï¸','ðŸ‘ƒ','ðŸ‘‚','ðŸ‘„','ðŸ¦µ','ðŸ¦¶','âœ‹','ðŸ–ï¸','ðŸ‘‹','ðŸ‘','ðŸ¤²',

  // ðŸ¤• Illness Faces
  'ðŸ¤•','ðŸ¤’','ðŸ¤¢','ðŸ¤®','ðŸ˜·','ðŸ¥µ','ðŸ¥¶','ðŸ˜µ','ðŸ¥´','ðŸ˜´','ðŸ˜ª','ðŸ˜«','ðŸ˜“','ðŸ˜­','ðŸ˜°','ðŸ˜¨','ðŸ˜–','ðŸ˜©','ðŸ¥º','ðŸ˜¤',

  // ðŸ’Š More Medical
  'ðŸ’Š','ðŸ©¸','ðŸ©¼','ðŸ§»','ðŸ›Œ','ðŸ›ï¸','ðŸ›‘','ðŸš·','ðŸš³','ðŸ“‹','ðŸ“„','ðŸ“‘','ðŸ“†','ðŸ“…','ðŸ—‚ï¸','ðŸ“š','ðŸ“Œ','ðŸ”–','ðŸ“Ž','ðŸ“','ðŸ“ž',

  // â¤ï¸ Health Symbols
  'â¤ï¸','ðŸ§¡','ðŸ’›','ðŸ’š','ðŸ’™','ðŸ’œ','ðŸ–¤','ðŸ¤','ðŸ¤Ž','ðŸ’–','ðŸ’“','ðŸ’—','ðŸ’˜','ðŸ’','ðŸ’Ÿ','ðŸ’¯','ðŸ’¢',

  // ðŸ™ Supportive Gestures
  'ðŸ™','ðŸ™Œ','ðŸ‘','ðŸ‘','ðŸ‘Ž','ðŸ¤','ðŸ‘Š','âœ‹','ðŸ«¶','ðŸ¤—','ðŸ«±','ðŸ«²','ðŸ«³','ðŸ«´','ðŸ«°','ðŸ‘Œ','ðŸ¤Œ','ðŸ¤™','ðŸ––',


  // ðŸ§‘â€âš–ï¸ People & Professions (extra padding)
  'ðŸ§‘â€âš–ï¸','ðŸ§‘â€ðŸ³','ðŸ§‘â€ðŸš’','ðŸ§‘â€âœˆï¸','ðŸ§‘â€ðŸš€','ðŸ§‘â€ðŸŽ¨','ðŸ§‘â€ðŸ”§','ðŸ§‘â€ðŸ”¬','ðŸ§‘â€ðŸ’»','ðŸ§‘â€ðŸŒ¾','ðŸ§‘â€ðŸ­','ðŸ§‘â€ðŸ«','ðŸ§‘â€ðŸ’¼','ðŸ§‘â€ðŸŽ“',

  // ðŸŽ‰ Encouragement
  'ðŸŽ‰','âœ¨','ðŸŽŠ','ðŸŒŸ','ðŸ†','ðŸŽ–ï¸','ðŸ¥‡','ðŸ¥ˆ','ðŸ¥‰','ðŸ’','ðŸŒ¸','ðŸŒ¼','ðŸŒˆ','â˜€ï¸','ðŸŒ¤ï¸','ðŸ’Ž','ðŸ§¿','ðŸ”†','ðŸ“£','ðŸ“¢',

  // ðŸ”” Tools, Tech
  'ðŸ”¬','ðŸ”­','ðŸ“¡','ðŸ“±','ðŸ“²','ðŸ’»','ðŸ–¥ï¸','ðŸ–¨ï¸','ðŸ—ƒï¸','ðŸ—„ï¸','ðŸ—‘ï¸','ðŸ“¶','ðŸ”‹','ðŸ”Œ','ðŸ”Ž','ðŸ”',

  // ðŸ“§ Communication
  'ðŸ“§','ðŸ“¨','ðŸ“©','ðŸ“¤','ðŸ“¥','ðŸ“¦','ðŸ—³ï¸','âœ‰ï¸','ðŸ“ª','ðŸ“«','ðŸ“¬','ðŸ“­','ðŸ“®','ðŸ“¯','ðŸ“œ','ðŸ“ƒ',

  'ðŸ’ƒ', 'ðŸ•º', 'ðŸª©', 'ðŸŽ‰', 'ðŸ•´ï¸', 'ðŸ‘¯â€â™€ï¸', 'ðŸ‘¯â€â™‚ï¸', 'âœ¨', 'ðŸŽ¶', 'ðŸŽµ', 'ðŸ”¥', 'ðŸ™Œ',

    ];

    emojis.forEach(e => {
      const span = document.createElement('span');
      span.textContent = e;
      span.style.fontSize = '22px';
      span.style.cursor = 'pointer';
      span.style.margin = '4px';
      span.addEventListener('click', () => {
        const start = chatInput.selectionStart;
        const end = chatInput.selectionEnd;
        const text = chatInput.value;
        chatInput.value = text.slice(0, start) + e + text.slice(end);
        chatInput.focus();
        chatInput.selectionStart = chatInput.selectionEnd = start + e.length;
      });
      emojiPicker.appendChild(span);
    });

    emojiToggle.addEventListener('click', () => {
      emojiPicker.classList.toggle('d-none');
    });

    document.addEventListener('click', (e) => {
      if (!emojiPicker.contains(e.target) && e.target !== emojiToggle) {
        emojiPicker.classList.add('d-none');
      }
    });
  });
</script>


  <script>
    function updateLastSeen() {
      fetch("{% url 'update_last_seen' %}", {
        method: "GET",
        credentials: "same-origin",  // send cookies/session
      }).catch(error => {
        console.warn("Last seen update failed:", error);
      });
    }

    updateLastSeen();

    // Then keep updating every 30 seconds
    setInterval(updateLastSeen, 30000);
  </script>

  <script>
  document.getElementById("chat-msg").addEventListener("keypress", function (e) {
      if (e.key === "Enter") {
        e.preventDefault();
        document.getElementById("send").click();
      }
    });
  </script>




<script>
  document.addEventListener('DOMContentLoaded', function () {
    const toggleBtn = document.getElementById('toggle-prescription');
    const collapseDiv = document.getElementById('add-presc');
    const bsCollapse = new bootstrap.Collapse(collapseDiv, { toggle: false });

    let isVisible = false;

    // Toggle on button click
    toggleBtn.addEventListener('click', function (e) {
      e.stopPropagation();  // Prevent triggering the document click
      if (isVisible) {
        bsCollapse.hide();
      } else {
        bsCollapse.show();
      }
      isVisible = !isVisible;
    });

    // Hide when clicking outside
    document.addEventListener('click', function (e) {
      const wrapper = document.getElementById('prescription-wrapper');
      if (isVisible && !wrapper.contains(e.target)) {
        bsCollapse.hide();
        isVisible = false;
      }
    });
  });
</script>


<script>
  document.getElementById('close-no-btn').addEventListener('click', function () {
    const demo2 = document.getElementById('demo2');
    const bsCollapse = bootstrap.Collapse.getOrCreateInstance(demo2);
    bsCollapse.hide();
  });
</script>



  {% endblock %}