{% load static %}

<!doctype html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">


  <script src="https://code.jquery.com/jquery-3.4.1.js" integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU="
    crossorigin="anonymous"></script>



  <!-- Bootstrap CSS -->

  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

  <link rel="stylesheet" href="{% static 'homepage/bootstrap/css/bootstrap.min.css' %}">


  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">


  <title>Healurix</title>

  <link rel="icon" href="{% static 'homepage/favicon-96x96.png' %}" type="image/png">
  



<style>
  .img {
    position: relative;
    float: left;
    background-position: 100% 100%;
    background-repeat: no-repeat;
    background-size: cover;
  }

  .background-blur {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background-image: url("{% static 'homepage/background3.png' %}");
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    z-index: -1;
    filter: blur(6px);
    opacity: 0.4;
    pointer-events: none;
    /* prevent any accidental clicks */
  }

  html,
  body {
    height: 100%;
    margin: 0;
    display: flex;
    flex-direction: column;
  }

  body {
    flex: 1;
    position: relative;
    z-index: 0;
  }

  footer {
    margin-top: auto;
  }


  #notificationContainer {
    position: absolute;
    bottom: 20px;
    right: 20px;
    z-index: 1055;
    max-height: 90vh;
    width: 300px;
    display: flex;
    flex-direction: column;
  }

  #notificationBadge {
    flex-shrink: 0;
    /* badge remains fixed */
    font-size: small;
  }

  #chatToastWrapper {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1080;
    max-height: 250px;
    overflow-y: auto;
    width: 300px;
    /* Adjust width as needed */
    padding-right: 5px;


  }



  #chatToastWrapper:hover {
    overflow-y: auto;
  }

  /* Scrollbar styling */
  #chatToastWrapper::-webkit-scrollbar {
    width: 6px;
  }

  #chatToastWrapper::-webkit-scrollbar-thumb {
    background: rgba(0, 0, 0, 0.2);
    border-radius: 4px;
  }

  /* Fade indicator at the bottom */
  #chatToastWrapper::after {
    content: "";
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;

    pointer-events: none;
  }



  #chatToastContainer .toast {
    width: 100%;
    margin-bottom: 10px;
  }



  .sign-in-option {
    text-decoration: none;
    color: inherit;
    transition: transform 0.3s ease;
  }

  .sign-in-option:hover .img-hover {
    transform: scale(1.05);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
  }

  .option-label {
    font-size: 1.2rem;
    font-weight: 600;
    color: #333;
  }

  .sign-up-option {
    text-decoration: none;
    color: inherit;
    transition: transform 0.3s ease;
  }

  .sign-up-option:hover .img-hover {
    transform: scale(1.05);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
  }
</style>



{% block head %}


{% endblock %}



</head>

<div class="background-blur"></div>


<body>



  <div class="container-fluid">


    <nav class="navbar navbar-expand-lg navbar-light" style="background-color: linear-gradient(to right, #d0eaff, #b2ebf2); border-bottom: 1px solid #dee2e6;  
              box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);">
      <a class="navbar-brand" href="{% url 'home' %}"><img src="{% static 'homepage/healurix_navbar_logo4.png' %}"
          alt="Healurix Logo" width="150px" height="50px"></a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav ml-auto">



          {% if user.is_authenticated %}

          {% if user.patient %}

          <li class="nav-item ml-2">
          <li class="nav-link text-dark" href="{% url 'patient_ui' %}" style="color:darkslategrey;">
            <strong>Hello, {{user.patient.name}}</strong>
          </li>

          <li class="nav-item ml-2">
            <a class="nav-link text-dark" href="{% url 'home' %}">
              <i class="bi bi-house-door-fill"></i>
              Home
            </a>
          </li>
          <li class="nav-item ml-2">
            <a class="nav-link text-dark" href="{% url 'patient_ui' %}">
              <i class="bi bi-person-plus-fill"></i>
              Your Profile
            </a>
          </li>

          {% endif %}

          {% if user.doctor %}

          <li class="nav-item ml-2">
          <li class="nav-link text-dark" href="{% url 'doctor_ui' %}">
            <strong>Hello, Dr.{{user.doctor.name}} </strong>
          </li>
          </li>

          <li class="nav-item ml-2">
            <a class="nav-link text-dark" href="{% url 'home' %}">
              <i class="bi bi-house-door-fill"></i>
              Home
            </a>
          </li>

          <li class="nav-item ml-2">
            <a class="nav-link text-dark" href="{% url 'doctor_ui' %}">
              <i class="fas fa-user-md me-1"></i>
              Your Profile
            </a>
          </li>


          {% endif %}


          {% if user.is_superuser %}

          <li class="nav-item ml-2">
          <li class="nav-link text-dark" href="{% url 'admin_ui' %}">
            <strong>Hello Admin : {{user.username}} </strong>
          </li>
          </li>

          <li class="nav-item ml-2">
            <a class="nav-link text-dark" href="{% url 'home' %}">
              <i class="bi bi-house-door-fill"></i>
              Home
            </a>
          </li>

          <li class="nav-item ml-2">
            <a class="nav-link text-dark" href="{% url 'admin_ui' %}">
              <i class="fas fa-user-tie"></i>
              Your Profile
            </a>
          </li>


          {% endif %}

          &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
          <li class="nav-item ml-2">
            <button class="btn btn-danger btn-xs" data-toggle="modal" data-target="#logout-modal"
              style="color: rgb(247, 190, 188);">
              <i class="bi bi-box-arrow-right"></i>
              Log out
            </button>
          </li>




          <!-- Small modal -->

          <div class="modal fade" id="logout-modal" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog modal-sm">
              <div class="modal-content">
                <div class="modal-header">
                  <h4>Logout <i class="fa fa-lock"></i></h4>
                </div>
                <div class="modal-body"><i class="fa fa-question-circle"></i><span style="color: rgb(42, 187, 6);">
                    {% if user.patient %}
                     {{ user.patient.name }} 
                    {% elif user.doctor %} 
                      Dr. {{ user.doctor.name }} 
                    {% else %} 
                      {{ user.username }} 
                    {% endif %}

                  </span>, Are you sure you want to log-off?</div>
                <div class="modal-footer">
                  <a href="{% url 'logout' %}" class="btn btn-danger btn-block">
                    <i class="bi bi-box-arrow-right"></i>&nbsp; Logout
                  </a>
                </div>
              </div>
            </div>
          </div>

          {% else %}

          <li class="nav-item ml-2">
            <a class="nav-link text-dark" href="{% url 'home' %}">
              <i class="bi bi-house-door-fill"></i>
              Home
            </a>
          </li>


          <li class="nav-item ml-2">

            <a class="nav-link text-dark" href="" data-toggle="modal" data-target=".bd-example-modal-lg2">
              <i class="fas fa-hospital-user"></i>
              Register
            </a>
          </li>
          <li class="nav-item ml-2">
            <a class="nav-link text-dark" href="" data-toggle="modal" data-target=".bd-example-modal-lg">
              <i class="bi bi-box-arrow-in-right"></i>
              Login
            </a>
          </li>

          {% endif %}

        </ul>
      </div>
    </nav>





    <!-- Sign Up Large modal -->

    <div class="modal fade bd-example-modal-lg2" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel"
      aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content p-4">

          <h1 class="text-center mb-4">Sign-Up As</h1>

          <form>
            <div class="container mt-3 mb-4">
              <div class="row justify-content-center text-center">

                <!-- Doctor -->
                <div class="col-md-6 col-sm-12 mb-4">
                  <a href="{% url 'signup_doctor' %}" class="sign-up-option">
                    <img alt="doctor" src="{% static 'homepage/doctor_signup.png' %}" class="img-fluid img-hover"
                      style="height: 215px;">
                    <div class="mt-2 option-label">Doctor</div>
                  </a>
                </div>

                <!-- Patient -->
                <div class="col-md-6 col-sm-12 mb-4">
                  <a href="{% url 'signup_patient' %}" class="sign-up-option">
                    <img alt="patient" src="{% static 'homepage/patient_signup.png' %}" class="img-fluid img-hover"
                      style="height: 215px;">
                    <div class="mt-2 option-label">Patient</div>
                  </a>
                </div>

              </div>
            </div>
          </form>

        </div>
      </div>
    </div>








    <!-- Sign In Large modal -->

    <div class="modal fade bd-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel"
      aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content p-4">

          <h1 class="text-center mb-4">Sign-In As</h1>

          <form>
            <div class="container mt-3 mb-4">
              <div class="row justify-content-center text-center">

                <!-- Admin -->
                <div class="col-md-4 col-sm-6 mb-4">
                  <a href="{% url 'sign_in_admin' %}" class="sign-in-option">
                    <img alt="admin" src="{% static 'homepage/admin_signup_logo.png' %}" class="img-fluid img-hover"
                      style="height: 215px;">
                    <div class="mt-2 option-label">Admin</div>
                  </a>
                </div>

                <!-- Doctor -->
                <div class="col-md-4 col-sm-6 mb-4">
                  <a href="{% url 'sign_in_doctor' %}" class="sign-in-option">
                    <img alt="doctor" src="{% static 'homepage/doctor_signup.png' %}" class="img-fluid img-hover"
                      style="height: 215px;">
                    <div class="mt-2 option-label">Doctor</div>
                  </a>
                </div>

                <!-- Patient -->
                <div class="col-md-4 col-sm-6 mb-4">
                  <a href="{% url 'sign_in_patient' %}" class="sign-in-option">
                    <img alt="patient" src="{% static 'homepage/patient_signup.png' %}" class="img-fluid img-hover"
                      style="height: 215px;">
                    <div class="mt-2 option-label">Patient</div>
                  </a>
                </div>

              </div>
            </div>
          </form>

        </div>
      </div>
    </div>



    <!-- Scrollable Toast Container -->


    <div id="chatToastWrapper">
      <div id="chatToastContainer"></div>
    </div>






{% block body %}


{% endblock %}




  </div>


  <!-- Footer -->
<footer class="bg-dark text-white py-3 mt-auto w-100">
  <div class="container d-flex flex-column flex-md-row justify-content-between align-items-center">
    
    <!-- Left: Email -->
    <div class="mb-2 mb-md-0">
      <a href="mailto:anujpradhan208@gmail.com" class="text-white text-decoration-none">
        <i class="bi bi-envelope-fill"></i> help@helurix.com
      </a>
    </div>

    <!-- Center: Copyright -->
    <div class="text-center mb-2 mb-md-0 flex-grow-1">
      &copy; 2025 <a href="#" class="text-white text-decoration-none">Healurix</a>. All Rights Reserved.
    </div>

    <!-- Right: Social Icons -->
    <div class="d-flex gap-3 mb-2 mb-md-0">
      <a href="{% url 'home' %}" class="text-white" target="_blank">
        <i class="bi bi-instagram" style="font-size: 1.4rem;"></i>
      </a>
      <a href="{% url 'home' %}" class="text-white" target="_blank">
        <i class="bi bi-facebook" style="font-size: 1.4rem;"></i>
      </a>
      <a href="{% url 'home' %}" class="text-white" target="_blank">
        <i class="bi bi-twitter-x" style="font-size: 1.4rem;"></i>
      </a>
    </div>

  </div>
</footer> 



  <!-- Optional JavaScript -->
  <!-- jQuery first, then Popper.js, then Bootstrap JS -->

  <script src="https://code.jquery.com/jquery-3.4.1.js" integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU="
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
    integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
    crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
    integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
    crossorigin="anonymous"></script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>



<script>
  const toastContainer = document.getElementById("chatToastContainer");
  const currentUser = "{{ request.user.username }}";

  function showNotification(id, sender, message, timestamp) {
    const toastId = "toast-" + id;
    if (document.getElementById(toastId)) return;

    const toastHTML = `
      <div class="toast text-white bg-dark mb-2" role="alert" aria-live="assertive" aria-atomic="true"
          id="${toastId}" data-bs-autohide="false">
        <div class="d-flex">
          <div class="toast-body" style="cursor: pointer;" onclick="goToConsultation('${id}')">
            🔔 <strong>${sender}</strong>: ${message}
          <div class="small text-light mt-1" id="toast-timestamp-${id}">🕒 ${formatTimeAgo(timestamp)}</div>
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto"
                  data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      </div>`;

    toastContainer.insertAdjacentHTML("beforeend", toastHTML);
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement, { autohide: false });
    toast.show();

    toastElement.addEventListener('hidden.bs.toast', () => {
      const dismissedKey = `dismissedToasts_${currentUser}`;
      const activeKey = `activeToasts_${currentUser}`;
      let dismissed = JSON.parse(localStorage.getItem(dismissedKey) || "[]");
      let activeToasts = JSON.parse(localStorage.getItem(activeKey) || "[]");

      if (!dismissed.includes(id)) {
        dismissed.push(id);
        localStorage.setItem(dismissedKey, JSON.stringify(dismissed));
      }

      activeToasts = activeToasts.filter(t => t.id !== id);
      localStorage.setItem(activeKey, JSON.stringify(activeToasts));
    });
  }

  function formatTimeAgo(timestamp) {
    const past = new Date(timestamp);
    const now = new Date();
    const diffSeconds = Math.floor((now - past) / 1000);

    if (diffSeconds < 60) return "just now";
    if (diffSeconds < 3600) {
      const minutes = Math.floor(diffSeconds / 60);
      return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
    }
    if (diffSeconds < 86400 && past.getDate() === now.getDate()) {
      const hours = Math.floor(diffSeconds / 3600);
      return `${hours} hour${hours > 1 ? 's' : ''} ago`;
    }

    const yesterday = new Date(now);
    yesterday.setDate(now.getDate() - 1);
    if (past.toDateString() === yesterday.toDateString()) {
      return `Yesterday at ${past.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
    }

    return past.toLocaleDateString(undefined, {
      day: '2-digit', month: 'short', year: 'numeric',
    }) + " at " + past.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }

  function goToConsultation(chatId) {
    fetch(`/get_consultation_id_from_chat/${chatId}/`)
      .then(response => response.json())
      .then(data => {
        if (data.consultation_id && data.related_message_ids) {
          const activeKey = `activeToasts_${currentUser}`;
          const dismissedKey = `dismissedToasts_${currentUser}`;

          let activeToasts = JSON.parse(localStorage.getItem(activeKey) || "[]");
          let dismissedToasts = JSON.parse(localStorage.getItem(dismissedKey) || "[]");

          const updatedActive = activeToasts.filter(t => !data.related_message_ids.includes(t.id));
          localStorage.setItem(activeKey, JSON.stringify(updatedActive));

          data.related_message_ids.forEach(id => {
            document.getElementById("toast-" + id)?.remove();
            if (!dismissedToasts.includes(id)) {
              dismissedToasts.push(id);
            }
          });

          localStorage.setItem(dismissedKey, JSON.stringify(dismissedToasts));
          window.location.href = `consultationview/${data.consultation_id}`;
        }
      });
  }

  function restoreToasts() {
    const activeKey = `activeToasts_${currentUser}`;
    const activeToasts = JSON.parse(localStorage.getItem(activeKey) || "[]");
    activeToasts.forEach(msg => {
      showNotification(msg.id, msg.sender, msg.preview, msg.timestamp);
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    const isProfilePage = window.location.pathname.includes("doctor_ui") ||
      window.location.pathname.includes("patient_ui");
    if (!isProfilePage) return;

    const dismissedKey = `dismissedToasts_${currentUser}`;
    const activeKey = `activeToasts_${currentUser}`;
    const dismissed = JSON.parse(localStorage.getItem(dismissedKey) || "[]");

    restoreToasts();

    setInterval(() => {
      fetch("{% url 'check_messages' %}")
        .then(response => response.json())
        .then(data => {
          let activeToasts = JSON.parse(localStorage.getItem(activeKey) || "[]");
          let dismissedToasts = JSON.parse(localStorage.getItem(dismissedKey) || "[]");

          if (data.has_new) {
            data.messages.forEach(msg => {
              const alreadyShown = document.getElementById("toast-" + msg.id);
              if (!dismissed.includes(msg.id) && !activeToasts.find(t => t.id === msg.id)) {
                showNotification(msg.id, msg.sender, msg.preview, msg.timestamp);
                activeToasts.push({ id: msg.id, sender: msg.sender, preview: msg.preview, timestamp: msg.timestamp });
              }
            });
          }

          if (Array.isArray(data.read_ids)) {
            const updatedActive = activeToasts.filter(t => !data.read_ids.includes(t.id));

            data.read_ids.forEach(id => {
              document.getElementById("toast-" + id)?.remove();
              if (!dismissedToasts.includes(id)) {
                dismissedToasts.push(id);
              }
            });

            localStorage.setItem(activeKey, JSON.stringify(updatedActive));
            localStorage.setItem(dismissedKey, JSON.stringify(dismissedToasts));
          }

        });
    }, 5000);

    setInterval(() => {
      document.querySelectorAll("[id^='toast-timestamp-']").forEach(el => {
        const id = el.id.replace("toast-timestamp-", "");
        const toastData = JSON.parse(localStorage.getItem(`activeToasts_${currentUser}`) || "[]")
          .find(t => t.id == id);
        if (toastData) {
          el.textContent = "🕒 " + formatTimeAgo(toastData.timestamp);
        }
      });
    }, 60000);  // Update time every minute
  });
</script>




</body>

</html>