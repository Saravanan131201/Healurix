{% extends "basic.html" %}
{% load static %}

{% block head %}
<link rel="stylesheet" href="{% static 'patient/view_profile/forms.css' %}">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
{% endblock %}

{% block body %}
<div class="container mt-5">
  <div class="card border-dark shadow-lg mx-auto" style="max-width: 600px;">
    <div class="card-body">
      <h3 class="card-title text-center mb-4">Patient Profile - {{ puser.patient.name }}</h3>
      {% with patient=puser.patient %}

      {% if request.user.patient %}
      <div class="form-group">
        <label>Username:</label>
        <p class="form-control-plaintext" id="username_static">{{ puser.username }}</p>
        <input type="text" class="form-control d-none" id="username_input" value="{{ puser.username }}" disabled>
      </div>
      {% endif %}

      <div class="form-group">
        <label>Name:</label>
        <p class="form-control-plaintext" id="name_static">{{ patient.name }}</p>
        <input type="text" class="form-control d-none" id="name_input" value="{{ patient.name }}">
      </div>

      <div class="form-group">
        <label>Email:</label>
        <p class="form-control-plaintext" id="email_static">{{ puser.email }}</p>
        <input type="email" class="form-control d-none" id="email_input" value="{{ puser.email }}" disabled>
      </div>

      <div class="form-group">
        <label>Date of Birth:</label>
        <p class="form-control-plaintext" id="dob_static">{{ patient.dob|date:'Y-m-d' }}</p>
        <input type="date" class="form-control d-none" id="dob_input" value="{{ patient.dob|date:'Y-m-d' }}">
      </div>

      <div class="form-group">
        <label>Age:</label>
        <p class="form-control-plaintext" id="age_static">{{ patient.age }}</p>
        <input type="text" class="form-control d-none" id="age_input" value="{{ patient.age }}" disabled>
      </div>

      <div class="form-group">
        <label>Gender:</label>
        <p class="form-control-plaintext" id="gender_static">{{ patient.gender|title }}</p>
        <select class="form-control d-none" id="gender_input">
          <option {% if patient.gender == "male" %}selected{% endif %}>male</option>
          <option {% if patient.gender == "female" %}selected{% endif %}>female</option>
          <option {% if patient.gender == "other" %}selected{% endif %}>other</option>
        </select>
      </div>

      <div class="form-group">
        <label>Address:</label>
        <p class="form-control-plaintext" id="address_static">{{ patient.address }}</p>
        <input type="text" class="form-control d-none" id="address_input" value="{{ patient.address }}">
      </div>

      <div class="form-group">
        <label>Mobile No:</label>
        <p class="form-control-plaintext" id="mobile_static">{{ patient.mobile_no }}</p>
        <input type="text" class="form-control d-none" id="mobile_input" value="{{ patient.mobile_no }}">
      </div>

      {% endwith %}

      {% if request.user.patient %}
      <div class="text-center mt-4">
        <button id="editBtn" class="btn btn-outline-primary">Edit</button>
        <button id="saveBtn" class="btn btn-success d-none">Save</button>
        <button id="cancelBtn" class="btn btn-danger d-none">Cancel</button>
      </div>
      {% endif %}
    </div>
  </div>
</div>


<br><br><br>

<script>
  $(document).ready(function () {
    $('#editBtn').click(function () {
      $('[id$="_static"]').hide();
      $('[id$="_input"]').removeClass('d-none');
      $('#saveBtn, #cancelBtn').removeClass('d-none');
      $('#editBtn').addClass('d-none');
    });

    $('#saveBtn').click(function () {
      $.ajax({
        url: "{% url 'savepdata' puser.username %}",
        type: "POST",
        data: {
          csrfmiddlewaretoken: '{{ csrf_token }}',
          name: $('#name_input').val(),
          dob: $('#dob_input').val(),
          gender: $('#gender_input').val(),
          address: $('#address_input').val(),
          mobile_no: $('#mobile_input').val()
        },
        success: function () {
          alert("Profile updated successfully!");
          location.reload();
        },
        error: function () {
          alert("Error updating profile. Please try again.");
        }
      });
    });

    $('#cancelBtn').click(function () {
      $('[id$="_static"]').show();
      $('[id$="_input"]').addClass('d-none');
      $('#editBtn').removeClass('d-none');
      $('#saveBtn, #cancelBtn').addClass('d-none');

      // Reset values
      $('#name_input').val("{{ puser.patient.name }}");
      $('#dob_input').val("{{ puser.patient.dob|date:'Y-m-d' }}");
      $('#gender_input').val("{{ puser.patient.gender }}");
      $('#address_input').val("{{ puser.patient.address }}");
      $('#mobile_input').val("{{ puser.patient.mobile_no }}");
    });
  });
</script>
{% endblock %}
